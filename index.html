<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Palliative Care Monitor â€¢ KPI2</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css" />
</head>

<body data-theme="ocean">
  <div id="app" class="app">
    <!-- Global toast/notification -->
    <div id="toast" class="toast toast-hidden" role="status" aria-live="polite">
      <span id="toast-text">â€”</span>
      <button id="toast-close" class="btn btn-ghost" aria-label="Close">Ã—</button>
    </div>

    <!-- Header -->
    <header class="app-header">
      <div class="brand">
        <div class="brand-icon glow-pulse" aria-hidden="true">âœ¦</div>
        <div>
          <h1 class="brand-title">Palliative Care Monitor</h1>
          <div class="brand-sub">Team: Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø© â€¢ Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ â€¢ Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†</div>
        </div>
      </div>

      <div class="header-actions">
        <div class="theme-switcher">
          <label for="theme-select" class="label">Theme</label>
          <select id="theme-select" class="select">
            <option value="ocean">ocean</option>
            <option value="glow">glow</option>
            <option value="mint">mint</option>
            <option value="rose">rose</option>
            <option value="down">down</option>
            <option value="upper">upper</option>
            <option value="dark">dark</option>
            <option value="light-blue">light blue</option>
            <option value="dark-blue">dark blue</option>
            <option value="tirkwaz">tirkwaz</option>
            <option value="gradient">gradient</option>
          </select>
        </div>

        <button id="btn-preferences" class="btn btn-primary" aria-haspopup="dialog">
          âš™ï¸ Preferences
        </button>
      </div>
    </header>

    <!-- Top toolbar -->
    <section class="toolbar">
      <div class="date-wrap">
        <div class="date-today">
          <span class="muted">Today:</span>
          <strong id="today-label">â€”</strong>
        </div>
        <button id="btn-new-day" class="btn btn-success">
          â³ Start New Day
        </button>
      </div>

      <div class="import-actions">
        <div class="import-group">
          <!-- Emphasized Add Patient button (visual boost will be in styles.css) -->
          <button id="btn-add-manual" class="btn btn-accent btn-cta">â• Add Patient</button>
          <button id="btn-import-out" class="btn">â¬†ï¸ Import Outpatient CSV</button>
          <button id="btn-import-in" class="btn">â¬†ï¸ Import Inpatient CSV</button>
          <a id="btn-download-template" class="btn btn-ghost" download href="#">
            â¤“ Download Template
          </a>
        </div>

        <div class="out-type">
          <label class="label">Outpatient Type</label>
          <select id="out-type-select" class="select">
            <option value="">â€”</option>
            <option value="OPC">OPC</option>
            <option value="Clinic consult">Clinic consult</option>
            <option value="TR">TR</option>
            <option value="P.Office">P.Office</option>
            <option value="other">other</option>
          </select>
          <input id="out-type-other" class="input" type="text" placeholder="Type when selecting other" />
        </div>
      </div>
    </section>

    <!-- Team counters -->
    <section class="counters">
      <div class="counter-card">
        <div class="counter-title">Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©</div>
        <div id="count-jawad" class="counter-num">0</div>
      </div>
      <div class="counter-card">
        <div class="counter-title">Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ</div>
        <div id="count-asala" class="counter-num">0</div>
      </div>
      <div class="counter-card">
        <div class="counter-title">Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†</div>
        <div id="count-amin" class="counter-num">0</div>
      </div>
      <div class="counter-card alt">
        <div class="counter-title">Total Today</div>
        <div id="count-total" class="counter-num">0</div>
      </div>
    </section>

    <!-- Filters -->
    <section class="filters">
      <div class="filter-row">
        <div class="filter-field">
          <label class="label">Department</label>
          <input id="filter-dept" class="input" type="text" placeholder="e.g., ICU / OPC ..." />
        </div>
        <div class="filter-field">
          <label class="label">Intervention</label>
          <select id="filter-intervention" class="select">
            <option value="">All</option>
            <option value="refill medication">refill medication</option>
            <option value="reassessment/dose modification">reassessment/dose modification</option>
            <option value="new assessment/new patient">new assessment/new patient</option>
          </select>
        </div>
        <div class="filter-field">
          <label class="label">Palliative Member</label>
          <select id="filter-member" class="select">
            <option value="">All</option>
            <option value="Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©">Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©</option>
            <option value="Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ">Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ</option>
            <option value="Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†">Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†</option>
          </select>
        </div>
        <div class="filter-field">
          <label class="label">Patient Name</label>
          <input id="filter-name" class="input" type="text" placeholder="Search by name" />
        </div>
        <div class="filter-field">
          <label class="label">Patient Code</label>
          <input id="filter-code" class="input" type="text" placeholder="Search by code" />
        </div>
        <div class="filter-field">
          <label class="label">Date</label>
          <input id="filter-date" class="input" type="date" />
        </div>
        <div class="filter-actions">
          <button id="btn-apply-filters" class="btn btn-primary">Apply</button>
          <button id="btn-clear-filters" class="btn btn-ghost">Clear</button>
        </div>
      </div>
    </section>

    <!-- Persistent table -->
    <section class="table-wrap">
      <div class="table-head">
        <div class="table-title">Patient Records (persisted; New Day does not clear)</div>
        <div class="table-actions">
          <button id="btn-export-weekly" class="btn">ğŸ“† Weekly Report</button>
          <button id="btn-export-monthly" class="btn">ğŸ—“ï¸ Monthly Report</button>
          <button id="btn-export-yearly" class="btn">ğŸ—ƒï¸ Yearly Report</button>
          <button id="btn-sync" class="btn btn-success">â‡… Sync</button>
        </div>
      </div>

      <div class="table-scroll">
        <table id="patients-table" class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Name</th>
              <th>Code</th>
              <th>In/Out</th>
              <th>Out Type</th>
              <th>Department</th>
              <th>Intervention</th>
              <th>Palliative Member</th>
              <th>Response Time</th>
              <th>Delay Reason</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="patients-tbody">
            <!-- filled dynamically -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Modals -->
    <!-- Add/Edit Patient -->
    <dialog id="modal-patient" class="modal">
      <form id="form-patient" class="modal-card" method="dialog">
        <header class="modal-header">
          <h3 id="modal-patient-title">Add Patient</h3>
          <button class="btn btn-ghost" type="button" data-close>Ã—</button>
        </header>

        <div class="modal-body grid-2">
          <div class="field">
            <label class="label">Date</label>
            <input id="fld-date" type="date" class="input" required />
          </div>

          <div class="field">
            <label class="label">Name</label>
            <input id="fld-name" type="text" class="input" required />
          </div>

          <div class="field">
            <label class="label">Code</label>
            <input id="fld-code" type="text" class="input" />
          </div>

          <div class="field">
            <label class="label">In/Out</label>
            <select id="fld-inout" class="select" required>
              <option value="out">Out patient</option>
              <option value="in">In patient</option>
            </select>
          </div>

          <div class="field">
            <label class="label">Out Type</label>
            <select id="fld-outtype" class="select">
              <option value="">â€”</option>
              <option value="OPC">OPC</option>
              <option value="Clinic consult">Clinic consult</option>
              <option value="TR">TR</option>
              <option value="P.Office">P.Office</option>
              <option value="other">other</option>
            </select>
            <input id="fld-outtype-other" class="input mt-2 hidden" type="text" placeholder="Other department..." />
          </div>

          <div class="field">
            <label class="label">Department</label>
            <input id="fld-dept" type="text" class="input" placeholder="ICU / OPD / Ward ..." />
          </div>

          <div class="field">
            <label class="label">Intervention</label>
            <select id="fld-intervention" class="select" required>
              <option value="refill medication">refill medication</option>
              <option value="reassessment/dose modification">reassessment/dose modification</option>
              <option value="new assessment/new patient">new assessment/new patient</option>
            </select>
          </div>

          <div class="field">
            <label class="label">Palliative Member</label>
            <select id="fld-member" class="select" required>
              <option value="Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©">Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©</option>
              <option value="Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ">Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ</option>
              <option value="Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†">Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†</option>
            </select>
          </div>

          <!-- New: Response Time + conditional Delay Reason -->
          <div class="field">
            <label class="label">Response Time</label>
            <select id="fld-response-time" class="select" required>
              <option value="within half hour">within half hour</option>
              <option value="within hour">within hour</option>
              <option value="more than hour">more than hour</option>
            </select>
          </div>

          <div class="field">
            <label class="label">Delay Reason (shown if more than hour)</label>
            <input id="fld-delay-reason" type="text" class="input hidden" placeholder="Explain reason for delay..." />
          </div>

          <div class="field field-col">
            <label class="label">Notes</label>
            <textarea id="fld-notes" class="textarea" rows="3" placeholder="..."></textarea>
          </div>
        </div>

        <footer class="modal-footer">
          <button class="btn btn-primary" id="btn-save-patient" type="submit">Save</button>
          <button class="btn btn-ghost" type="button" data-close>Cancel</button>
        </footer>
      </form>
    </dialog>

    <!-- Import CSV -->
    <dialog id="modal-import" class="modal">
      <form id="form-import" class="modal-card" method="dialog" enctype="multipart/form-data">
        <header class="modal-header">
          <h3 id="modal-import-title">Import CSV</h3>
          <button class="btn btn-ghost" type="button" data-close>Ã—</button>
        </header>
        <div class="modal-body">
          <div class="field">
            <label class="label">Choose CSV file</label>
            <input id="fld-file" class="input" type="file" accept=".csv,text/csv" required />
          </div>
          <p class="muted">Empty columns will be ignored automatically.</p>
          <div class="field">
            <label class="label">Apply Palliative Member to all (optional)</label>
            <select id="fld-bulk-member" class="select">
              <option value="">â€” None â€”</option>
              <option value="Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©">Ø¬ÙˆØ§Ø¯ Ø£Ø¨Ùˆ ØµØ¨Ø­Ø©</option>
              <option value="Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ">Ø£ØµØ§Ù„Ø© Ù†ÙˆØ¨Ø§Ù†ÙŠ</option>
              <option value="Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†">Ø£Ù…ÙŠÙ† Ø¯Ø­Ø¯ÙˆÙ„Ø§Ù†</option>
            </select>
          </div>
          <div class="field">
            <label class="label">Apply Department to all (optional)</label>
            <input id="fld-bulk-dept" class="input" type="text" placeholder="ICU / Ward / OPC ..." />
          </div>
        </div>
        <footer class="modal-footer">
          <button id="btn-import-submit" class="btn btn-primary" type="submit">Import</button>
          <button class="btn btn-ghost" type="button" data-close>Cancel</button>
        </footer>
      </form>
    </dialog>

    <!-- Preferences -->
    <dialog id="modal-preferences" class="modal">
      <form id="form-preferences" class="modal-card" method="dialog">
        <header class="modal-header">
          <h3>Preferences</h3>
          <button class="btn btn-ghost" type="button" data-close>Ã—</button>
        </header>

        <div class="modal-body grid-2">
          <div class="field">
            <label class="label">Animation speed (ms)</label>
            <input id="pref-speed" class="input" type="number" min="80" max="2000" step="20" value="240" />
          </div>

          <div class="field">
            <label class="label">Default transition</label>
            <select id="pref-motion" class="select">
              <option value="slide">slide</option>
              <option value="fade">fade</option>
              <option value="glow">glow</option>
            </select>
          </div>

          <div class="field field-col">
            <label class="label">Google Apps Script URL (optional)</label>
            <input id="pref-gas-url" class="input" type="url" placeholder="https://script.google.com/macros/s/XXXXX/exec" />
            <p class="muted">Default is set in schema.js â€” you can override it here.</p>
          </div>

          <div class="field">
            <label class="label">Auto sync to Google Sheets</label>
            <select id="pref-auto-sync" class="select">
              <option value="on">On</option>
              <option value="off">Off</option>
            </select>
          </div>

          <div class="field">
            <label class="label">UI density</label>
            <select id="pref-ui-density" class="select">
              <option value="cozy">Cozy</option>
              <option value="compact">Compact</option>
            </select>
          </div>
        </div>

        <footer class="modal-footer">
          <button class="btn btn-primary" id="btn-save-preferences" type="submit">Save</button>
          <button class="btn btn-ghost" type="button" data-close>Cancel</button>
        </footer>
      </form>
    </dialog>

    <!-- Hidden template(s) -->
    <template id="row-template">
      <tr class="row-enter">
        <td data-col="date"></td>
        <td data-col="name"></td>
        <td data-col="code"></td>
        <td data-col="inout"></td>
        <td data-col="outtype"></td>
        <td data-col="dept"></td>
        <td data-col="intervention"></td>
        <td data-col="member"></td>
        <td data-col="response_time"></td>
        <td data-col="delay_reason"></td>
        <td data-col="notes"></td>
        <td class="row-actions">
          <button class="btn btn-xs btn-ghost" data-action="edit">Edit</button>
          <button class="btn btn-xs btn-danger" data-action="delete">Delete</button>
        </td>
      </tr>
    </template>

    <footer class="app-footer">
      <small>Â© KPI2 â€¢ Web App runs static (GitHub Pages) â€¢ JSONP with GAS to avoid CORS</small>
    </footer>
  </div>

  <!-- Scripts -->
  <script type="module" src="./app.js"></script>
  <script type="module" src="./schema.js"></script>
  <script type="module" src="./analytics.js"></script>

  <script>
    // Small inline handler to toggle Delay Reason visibility based on Response Time (UI only; full logic in app.js will also enforce)
    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('fld-response-time');
      const reason = document.getElementById('fld-delay-reason');
      if (sel && reason) {
        const update = () => {
          if (sel.value === 'more than hour') reason.classList.remove('hidden');
          else { reason.classList.add('hidden'); reason.value = ''; }
        };
        sel.addEventListener('change', update);
        update();
      }
      const outSel = document.getElementById('fld-outtype');
      const outOther = document.getElementById('fld-outtype-other');
      if (outSel && outOther) {
        const upd = () => outOther.classList.toggle('hidden', outSel.value !== 'other');
        outSel.addEventListener('change', upd);
        upd();
      }
    });
  </script>
</body>
</html>
